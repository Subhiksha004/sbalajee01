<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Payment | Scholars Hub</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background-color: #f0f2f5; font-family: 'Segoe UI', sans-serif; }
        .sidebar { height: 100vh; background: white; width: 260px; position: fixed; }
        .main-content { margin-left: 260px; padding: 30px; }
        .payment-card { max-width: 500px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .qr-container { text-align: center; margin: 20px 0; }
        .qr-img { border: 2px solid #1a56db; padding: 10px; border-radius: 10px; width: 200px; }
        .timer { font-size: 2rem; font-weight: bold; color: #dc3545; }
        .receipt-box { border: 2px dashed #ccc; padding: 20px; background: #fffdf8; position: relative; }
        .stamp { position: absolute; top: 40px; right: 20px; color: green; border: 3px solid green; padding: 5px 10px; font-weight: bold; transform: rotate(-15deg); opacity: 0.8; font-size: 1.5rem; }
    </style>
</head>
<body>

    <div class="sidebar d-none d-md-block p-3">
        <h5 class="text-primary fw-bold"><i class="fas fa-graduation-cap"></i> Scholars Hub</h5>
        <a href="student.html" class="d-block mt-4 text-decoration-none text-secondary"><i class="fas fa-arrow-left"></i> Back to Dashboard</a>
    </div>

    <div class="main-content">
        
        <div id="paymentStep" class="payment-card">
            <h4 class="text-center mb-4">Confirm Payment</h4>
            <div class="d-flex justify-content-between mb-2"><span>Student:</span> <strong id="payName">---</strong></div>
            <div class="d-flex justify-content-between mb-2"><span>Course:</span> <strong id="payCourse">---</strong></div>
            <div class="d-flex justify-content-between mb-4"><span>Total Fee:</span> <strong id="payAmount" class="text-danger fs-4">---</strong></div>
            <button onclick="generateQR()" class="btn btn-primary w-100 py-2">Pay with QR Code <i class="fas fa-qrcode"></i></button>
        </div>

        <div id="qrStep" class="payment-card text-center" style="display: none;">
            <h4>Scan to Pay</h4>
            <p class="text-muted">Open your UPI App and scan this code.</p>
            
            <div class="qr-container">
                <img id="qrImage" src="" class="qr-img">
            </div>

            <p>Verifying Payment in...</p>
            <div id="timerDisplay" class="timer">10</div>
            <p class="small text-muted">Do not refresh the page.</p>
        </div>

        <div id="receiptStep" class="payment-card" style="display: none;">
            <div class="text-center text-success mb-3">
                <i class="fas fa-check-circle fa-4x"></i>
                <h3>Payment Successful!</h3>
            </div>

            <div class="receipt-box">
                <div class="stamp">PAID</div>
                <h5 class="text-center border-bottom pb-2">OFFICIAL RECEIPT</h5>
                <p class="mb-1"><strong>Receipt No:</strong> <span id="rcptNo"></span></p>
                <p class="mb-1"><strong>Date:</strong> <span id="rcptDate"></span></p>
                <p class="mb-1"><strong>Student:</strong> <span id="rcptName"></span></p>
                <p class="mb-1"><strong>Course:</strong> <span id="rcptCourse"></span></p>
                <p class="mb-0"><strong>Amount:</strong> <span id="rcptAmount" class="fw-bold"></span></p>
            </div>

            <button onclick="window.print()" class="btn btn-outline-dark w-100 mt-3"><i class="fas fa-print"></i> Print Receipt</button>
            <a href="student.html" class="btn btn-link w-100 mt-2">Back to Dashboard</a>
        </div>

    </div>

    <script>
        let feeAmount = 0;

        document.addEventListener("DOMContentLoaded", function() {
            
            const name = localStorage.getItem('userName');
            const course = localStorage.getItem('userCourse');
            const feeStatus = localStorage.getItem('feeStatus');

            document.getElementById('payName').innerText = name;
            document.getElementById('payCourse').innerText = course;

            
            const adminFees = JSON.parse(localStorage.getItem('courseFees')) || {};
            
            if (course === 'MBA') feeAmount = adminFees.MBA || 100000;
            else if (course === 'B.Tech') feeAmount = adminFees.BTech || 80000;
            else if (course === 'MCA') feeAmount = adminFees.MCA || 60000;
            else if (course === 'BCA') feeAmount = adminFees.BCA || 40000;
            else feeAmount = 50000;

            document.getElementById('payAmount').innerText = "₹ " + feeAmount.toLocaleString('en-IN');

            if(feeStatus === 'Paid') {
                showReceipt(true);
            }
        });

        function generateQR() {
            document.getElementById('paymentStep').style.display = 'none';
            document.getElementById('qrStep').style.display = 'block';

            const randomID = Math.floor(Math.random() * 1000000);
            const qrData = `UPI://pay?pa=scholars@bank&pn=ScholarsHub&am=${feeAmount}&tr=${randomID}`;
            document.getElementById('qrImage').src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(qrData)}`;

            let timeLeft = 10;
            const timerInterval = setInterval(() => {
                timeLeft--;
                document.getElementById('timerDisplay').innerText = timeLeft;

                if (timeLeft <= 0) {
                    clearInterval(timerInterval);
                    processBackendPayment();
                }
            }, 1000);
        }

        function processBackendPayment() {
            const userId = localStorage.getItem('userId');
            
            fetch(`/api/users/${userId}/pay`, { method: 'PUT' })
            .then(res => {
                if(res.ok) {
                    localStorage.setItem('feeStatus', 'Paid');
                    showReceipt(false);
                } else {
                    alert("System Error: Payment not recorded.");
                    location.reload();
                }
            });
        }

        function showReceipt(isHistory) {
            document.getElementById('paymentStep').style.display = 'none';
            document.getElementById('qrStep').style.display = 'none';
            document.getElementById('receiptStep').style.display = 'block';

            document.getElementById('rcptName').innerText = localStorage.getItem('userName');
            document.getElementById('rcptCourse').innerText = localStorage.getItem('userCourse');
            document.getElementById('rcptAmount').innerText = "₹ " + feeAmount.toLocaleString('en-IN');
            
            const date = new Date();
            document.getElementById('rcptDate').innerText = date.toLocaleDateString() + " " + date.toLocaleTimeString();
            
            const receiptNo = 'REC-' + Math.floor(Math.random() * 9000000 + 1000000);
            document.getElementById('rcptNo').innerText = receiptNo;
        }
    </script>
</body>
</html>